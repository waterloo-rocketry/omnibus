name: Enforce Team Approvals

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  enforce-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: Check for approvals from default-reviewers and omnibus-reviewers
        id: check_approvals
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, number: pull_number } = context.issue;
            
            // Fetch all reviews for the pull request
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number,
            });
            
            // Filter reviews that are approved
            const approvedReviews = reviews.filter(review => review.state === 'APPROVED');
            
            // Extract usernames of reviewers who approved
            const approvedUsers = [...new Set(approvedReviews.map(review => review.user.login))];
            
            const defaultTeam = 'default-reviewers'; // team slug
            const omnibusTeam = 'omnibus-reviewers'; // team slug
            const org = owner; // set repo owner is the org
            
            let defaultApproved = false;
            let omnibusApproved = false;
            
            for (const username of approvedUsers) {
              try {
                // Check if the user is a member of the default-reviewers team
                await github.rest.teams.getMembershipForUserInOrg({
                  org,
                  team_slug: defaultTeam,
                  username,
                });
                defaultApproved = true;
              } catch (error) {
                // User is not in default-reviewers team
              }
              
              try {
                // Check if the user is a member of the omnibus-reviewers team
                await github.rest.teams.getMembershipForUserInOrg({
                  org,
                  team_slug: omnibusTeam,
                  username,
                });
                omnibusApproved = true;
              } catch (error) {
                // User is not in omnibus-reviewers team
              }
            }
            
            if (!defaultApproved || !omnibusApproved) {
              core.setFailed(
                'Pull request must be approved by at least one member from both default-reviewers and omnibus-reviewers.'
              );
            }
