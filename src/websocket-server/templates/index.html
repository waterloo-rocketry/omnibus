<!DOCTYPE html>
<html>
  <head>
    <title>Omnibus Socket.IO Test</title>
  </head>
  <body>
    <h1>Socket.IO HTML Client For Testing</h1>

    <button id="sendBtn">Send Info Back</button>

    <pre id="log"></pre>

    <script>
      const log = (msg) => {
          const logElem = document.getElementById("log");
          logElem.textContent = msg;
          logElem.scrollTop = logElem.scrollHeight;
      };
      log("HTML loaded, connecting...");
    </script>

    <script type="module">
      import { io } from "https://esm.sh/socket.io-client@4.7.5";
      import msgpackParser from "https://esm.sh/socket.io-msgpack-parser@3.0.2";

      const log = (msg) => {
          const logElem = document.getElementById("log");
          logElem.textContent = msg;
          logElem.scrollTop = logElem.scrollHeight;
      };

      // Connect with msgpack parser to match server's serializer="msgpack"
      const socket = io({ parser: msgpackParser });
      socket.on("connect", () => log("connected id=" + socket.id));
      socket.on("connect_error", (err) => log("connect_error " + err));
      socket.on("DAQ/Fake", (data) => {
        // Data arrives as a JS object (deserialized by socket.io-msgpack-parser)
        log("omnibus_message\n" + JSON.stringify(data, null, 2));
      });
      socket.on("disconnect", () => log("disconnected"));

      document.getElementById("sendBtn").onclick = () => {
        console.log("Send Info Back button clicked");
        const msg = {
          channel: "send_back",
          timestamp: Date.now(),
          payload: { info: "Hello from HTML client!" },
        };
        log("sending publish\n" + JSON.stringify(msg, null, 2));
        socket.emit("publish", [msg.channel, [msg.timestamp, msg.payload]]);
      };
    </script>
  </body>
</html>
